<!DOCTYPE html>
<html>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/CSS" href="wsexp.css">
    <title>Trick Sim Control</title>

<!--START OF GRID LAYOUT -->
<body>
    <div id="parent"> 
        <nav id="navchild">
            <button class="navbutton"><u>F</u>ile</button>
            <button class="navbutton"><u>A</u>ctions</button>
        </nav>
        <header id="headerchild">
            <img src="../images/trick.png" id="trickpic">
            <h1>Sim Control</h1>
            <hr id="line" >
        </header> 
        <div id="tablechild"> 
            
            <table class="variables">
                <h2>Simulation Variable Table</h2>
                    <tr>
                        <th class="table">Variable</th>
                        <th class="table">Value</th>
                    </tr> 
            </table>
        </div>
        <div id="modechild">
        <table class="modebar">
            <tr>
                <th id="modeheader">Mode</th>
                <tr>
                    <td>0%</td>
                </tr>
                
            </tr>
        </table>
        </div>
        <div id="buttonchild" >
            <table class="commands">
       
                <th id="command" colspan="2" >Commands</th>
            
                <tr>
                    <td class="cmdbtn"><button class="cmdbtn" id="step" >Step</button> </td>
                    <td class="cmdbtn"><button class="cmdbtn" id="data" checked="checked">Data Rec On</button></td>
                </tr>
           
                <tr>
                    <td class="cmdbtn"><button class="cmdbtn" id="start">Start</button></td>
                    <td class="cmdbtn"><button class="cmdbtn" id="realtime">RealTime On</button></td>
                </tr>
                <tr>
                   <td class="cmdbtn" ><button class="cmdbtn" id="freeze">Freeze</button></td> 
                   <td class="cmdbtn"><button class="cmdbtn" id="dump">Dump Chkpnt</button></td>
                </tr>
                <tr>
                    <td class="cmdbtn"><button class="cmdbtn" id="shutdown">Shutdown</button></td> 
                    <td class="cmdbtn"><button class="cmdbtn" id="load">Load Chkpnt</button></td> 
                </tr>
                <!--My experiments-->
                <tr>
                 
                    <td class="cmdbtn" colspan="2"><button onclick="window.close()" class="cmdbtn" id="exit">E<u>x</u>it</button></td> 
                   <!-- <td><button onclick="setSimTime(value)">EXP</button></td> -->
                </tr>
           
            </table>
        </div>
        <div id="barchild">
            Here is a place for the buttons that start Trick TV, MTV, and Throttle.
            <hr id="line">
        </div>
        <div id="bottomchild">
            <table  class="bottomchild"> 
                <tr> 
                    <th class="bottomheader">Simulations/Overruns</th>
                </tr>
                <tr>
                    <td id="path" >Trick Simulation Path</td>
                </tr>
                <tr> 
                    <th class="bottomheader" >Status Messages</th>
                </tr>
                <tr>
                    <td>Status Message</td>
                </tr>
                <tr>
                    <th id="isconnected"></th>
                </tr>
            </table>
        </div>
      
        <div id="timechild">
            <table id="timetable">
                <tr>
                    <th id="timeheader">Time</th>
                </tr>
                <tr>
                    <th>RET (sec)</th>
                </tr>
                <tr>
                    <td id="RET" script="setSimTime()">0</td>
                </tr>
                <tr>
                    <th>Sim / Real Time</th>
                </tr>
                    <td>1</td>
            </table>
        </div>
    </div>

    <div id="output">
        <script type="text/javascript">
            function log(s) {
                var p = document.createElement("p");
                p.style.wordWrap = "break-word";
                p.textContent = s;
                output.appendChild(p);
            }
            function sendMessage(msg) {
                ws.send(msg);
                //log("Sent : " + msg);
            }
            // Interface to Trick WebSocket Variable Server
            function setPeriod(period) {
                sendMessage(`{"cmd":"var_cycle","period":${period}}`);
            }
            function addVarTableRow(name, value) {
                // create a row in the table that contains two <td>s, one for the var_name and one for its value.
                let tr = document.createElement('tr');  
                let td1 = document.createElement('td');
                td1.textContent = `${name}`;
                let td2 = document.createElement('td');
                td2.textContent = `${value}`;
                td2.className = "values";
                tr.appendChild(td1);
                tr.appendChild(td2);
                varTable.appendChild(tr);
            }
            function addVariable(name, value) {
                sendMessage(`{"cmd":"var_add","var_name": "${name}"}`);
                addVarTableRow(name, value);
            }
           
            // Button Functions
            document.getElementById("shutdown").onclick = function shutdownSIM(){
                sendMessage(`{"cmd": "python", "pycode": "trick.stop()"}`);
            }
            document.getElementById("start").onclick = function startSIM(){
                sendMessage(`{"cmd": "python", "pycode": "trick.exec_run()"}`);
            }
            document.getElementById("freeze").onclick = function freezeSIM(){
                sendMessage(`{"cmd": "python", "pycode": "trick.exec_freeze()"}`);
                sendMessage(`{"cmd": "python", "pycode": "trick.debug_pause_off()"}`);
            }
            document.getElementById("step").onclick = function stepSIM(){
                sendMessage(`{"cmd": "python", "pycode": "trick.debug_pause_on()"}`);
                sendMessage(`{"cmd": "python", "pycode": "trick.exec_run()"}`);
                sendMessage(`{"cmd": "python", "pycode": "trick.debug_signal()"}`);
            }
            // Sets the data rec and real time on by default 
            document.getElementById("data").checked = true;
            document.getElementById("realtime").checked = true;
            document.getElementById("data").onclick =function dataRecordSim(){
                var dataRecButton = document.getElementById("data");
                if (dataRecButton.checked == false){
                    dataRecButton.innerText = "Data Rec On";
                    sendMessage(`{"cmd": "python", "pycode": "trick.dr_enable()"}`);
                    dataRecButton.checked = true;
                } else {
                    dataRecButton.innerText = "Data Rec Off";
                    sendMessage(`{"cmd": "python", "pycode": "trick.dr_disable()"}`);
                    dataRecButton.checked = false;
                }
            }
            document.getElementById("realtime").onclick =function realtimeSim(){
                var realtimeButton = document.getElementById("realtime");
              
              
                if (realtimeButton.checked == false){
                  realtimeButton.innerText = "RealTime On";
                  sendMessage(`{"cmd": "python", "pycode": "trick.real_time_enable()"}`);
                  realtimeButton.checked = true;
                    } else {
                  realtimeButton.innerText = "RealTime Off";
                  sendMessage(`{"cmd": "python", "pycode": "trick.real_time_disable()"}`);
                  realtimeButton.checked = false;
                }
            }
            // Sets sim time and directory for load/dump 
            // Creates object for sim information such as time and directory
            var simInfo = new Object();
            function setSimTime(t){
                simInfo.time = t.toFixed(2);
                document.getElementById("RET").innerHTML = simInfo.time;
            }
            function setSimDir (r,d){
                simInfo.dir = d + "/" + r;
               // console.log(simInfo.dir);
                document.getElementById("path").innerHTML = simInfo.dir;
            }
            function setSimMode(m){
                simInfo.mode = m;

                switch (m){
                    case '0':
                        document.getElementById("modeheader").innerText = "Initialization Mode";
                    break;
                    case '1':
                        document.getElementById("modeheader").innerText = "Freeze Mode";
                    break;
                    case '4':
                        document.getElementById("modeheader").innerText = "Debug Stepping Mode";
                    break;
                    case '5':
                        document.getElementById("modeheader").innerText = "Run Mode";
                    break;
                    case '6': 
                        document.getElementById("modeheader").innerText = "Exit Mode";
                    break;
                    default:
                        document.getElementById("modeheader").innerText = "N/A";

                }
            }
            function setServerPort(p){
                simInfo.port = p;
                document.getElementById("isconnected").innerHTML = "Connection established on port " + simInfo.port;

            }
            function changeServerPort(){
                var newPort = prompt("Enter new port: ");
                // can we use python to change input.py web.server.port
               // sendMessage(`{"cmd": "python", "pycode": "'web.server.port' + '=' + '${newPort}'"}`);
                sendMessage(`{"cmd": "python", "pycode": "'Trick::ExternalApplication::set_port'"}`);

            }
            
            
            // MY EXPERIMENTS
            function loadChkpnt (){
                var file = "chkpnt_" + simTime;
                sendMessage(`{"cmd": "python", "pycode": "trick.load_checkpoint('${simDir}' + '/' + '${file}')"}`);
            }
            function dumpChkpnt (){
                var file = "chkpnt_" + simTime;
                
                sendMessage(`{"cmd": "python", "pycode": "trick.checkpoint('${file}')"}`);
               
               /* Unable to do send last command due to no checkpoint objects 
               
               sendMessage(`{"cmd": "python", "pycode": "trick.checkpoint_objects('${file}' + ',' + '${checkpointObjects}')"}`);
                 if (file != null){
                    
                        if (checkpointObjects == null || "".equals(checkpointObjects)){
                            sendMessage(`{"cmd": "python", "pycode": "trick.checkpoint('${file}')"}`);
                        } else {
                            sendMessage(`{"cmd": "python", "pycode": "trick.checkpoint_objects('${file}' + ',' + '${checkpointObjects}')"}`);
                        }
                } */
            }
        
            // Working on enable/disable buttons
            function enableAllButtons(commandStr, flag){
                if (commandStr != null){
                    const commands = commandStr.split(", ");
                    setCommandsEnabled(acts, flag);
                }
            }
            function disableAllButtons(commands, flag){
                const button = document.querySelectorAll('button');
               // button.disabled = true; 
            }
            function getAllButtons (){
                const commands = ["step", "start", "freeze", "shutdown", "data", "realtime",
                "dump", "load"];
                for (let x = 0; x < commands.length; x++){
                    document.getElementById(commands[x]);
                    const button = document.querySelector(commands[x]);
                    button.disabled = true;
                    console.log(commands[x]);
                }

            }

            // END OF EXPERIMENT 
            var varTable = document.querySelector('table.variables');
            var ws = new WebSocket('ws://localhost:8888/api/ws/VariableServer');
             
            // WebSocket Event Handlers
            ws.onopen = function(e) {
               // document.getElementById("isconnected").innerHTML = "Connection established " + windowPort;
               // let windowLocation = window.location.host;
               // log("Connection established");
                setPeriod(100);
                changeServerPort();
                sendMessage(`{"cmd":"var_add","var_name": "trick_cmd_args.cmd_args.run_dir"}`);
                sendMessage(`{"cmd":"var_add","var_name": "trick_cmd_args.cmd_args.default_dir"}`);
                sendMessage(`{"cmd":"var_add","var_name": "web.server.port"}`);
                sendMessage(`{"cmd":"var_send"}`); 
                sendMessage('{"cmd":"var_clear"}');
                addVarTableRow("Time", 0.0);
                addVariable("trick_sys.sched.mode", 0);
                addVariable("trick_sys.name", 'trick_sys');
                addVariable("dyn.balloon.pos[0]", 0.0);
                addVariable("dyn.balloon.pos[1]", 0.0);
                addVariable("dyn.balloon.vel[0]", 0.0);
                addVariable("dyn.balloon.vel[1]", 0.0);
                addVariable("dyn.balloon.envelope_air_temperature", 92.0);
                addVariable("dyn.balloon.wind_speed", 0.0);
                sendMessage('{"cmd":"var_unpause"}');
            };
            ws.onmessage = function(e) {
               //log("Recieved : " + e.data);
               let msg = JSON.parse(e.data);
               console.log(msg);
               if (msg.msg_type == "values") {
                let valueNodes = varTable.getElementsByClassName("values");
                valueNodes[0].textContent = msg.time;
                let simMode = valueNodes[1].textContent;
                setSimMode(simMode);
                setSimTime(msg.time);
                for (let i = 0; i < msg.values.length; i++ ) {
                       valueNodes[i+1].textContent = msg.values[i];
                       //console.log(msg.values[i]);
                   }

                if (msg.values.length == 3){
                    let runDir = msg.values[0];
                    console.log(runDir);
                    let defDir = msg.values[1];
                    console.log(defDir);
                    setSimDir(runDir, defDir);
                    let serverPort = msg.values[2];
                    setServerPort(serverPort);
                }
               }
            }; 	
            ws.onerror = function(e) {
               console.log("WebSocket Error: " , e);
              // handleErrors(e);
            };
            ws.onclose = function(e) {
               console.log("Connection closed", e);
              // window.close();
            };
  
        </script>
    </div>
</body>
</html>